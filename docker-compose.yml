services:
  postgres:
    image: postgres:16-alpine
    container_name: telemetra-postgres
    volumes:
      - "./files/postgres-data:/var/lib/postgresql/data"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=telemetra
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_connections=100
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=4
    networks:
      telemetra-network:
        aliases:
          - postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  questdb:
    image: questdb/questdb:9.1.1
    container_name: telemetra-questdb
    volumes:
      - "./files/questdb-data:/var/lib/questdb"
    environment:
      # JVM
      - QDB_JAVA_OPTS=-Xms2G -Xmx6G -XX:+UseG1GC

      # HTTP
      - QDB_HTTP_ENABLED=true
      - QDB_HTTP_BIND_TO=0.0.0.0:9000
      - QDB_HTTP_NET_CONNECTION_LIMIT=32
      - QDB_HTTP_SECURITY_READONLY=false
      - QDB_HTTP_MIN_ENABLED=false
      - QDB_HTTP_RECEIVE_BUFFER_SIZE=512K

      # PostgreSQL
      - QDB_PG_ENABLED=false

      # InfluxDB Line Protocol
      - QDB_LINE_TCP_ENABLED=true
      - QDB_LINE_TCP_BIND_TO=0.0.0.0:9009
      - QDB_LINE_HTTP_ENABLED=true

      # CPU
      - QDB_SHARED_WORKER_COUNT=2
      - QDB_HTTP_WORKER_COUNT=2

      # Memory
      - QDB_CAIRO_PAGE_FRAME_COUNT=1024
      - QDB_CAIRO_PAGE_FRAME_SIZE=64k
      - QDB_CAIRO_O3_COLUMN_MEMORY_SIZE=2M
      - QDB_CAIRO_SQL_MAP_PAGE_SIZE=2M

      # Write
      - QDB_CAIRO_WRITER_DATA_APPEND_PAGE_SIZE=1M
      - QDB_CAIRO_MAX_UNCOMMITTED_ROWS=250000
      - QDB_CAIRO_COMMIT_LAG=10000

      # Query
      - QDB_CAIRO_SQL_QUERY_TIMEOUT=30000

      # Logging
      - QDB_LOG_W_LEVEL=CRITICAL
      - QDB_LOG_W_FILE_LOCATION=stdout

      # Telemetry
      - QDB_TELEMETRY_ENABLED=false
      - QDB_METRICS_ENABLED=false
    networks:
      telemetra-network:
        aliases:
          - questdb
    restart: unless-stopped

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: telemetra-server
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=3001
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - WEB_URL=${WEB_URL}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/telemetra
      - REDIS_REST_URL=${REDIS_REST_URL}
      - REDIS_REST_TOKEN=${REDIS_REST_TOKEN}
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      questdb:
        condition: service_started
    networks:
      telemetra-network:
        aliases:
          - server
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/v1/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

networks:
  telemetra-network:
    driver: bridge

