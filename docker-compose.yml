services:
  postgres:
    image: postgres:17
    container_name: telemetra-postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=telemetra
    command: >
      postgres
      -c shared_buffers=512MB
      -c effective_cache_size=2GB
      -c maintenance_work_mem=192MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=16MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_connections=100
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=4
    networks:
      telemetra-network:
        aliases:
          - postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:8.0.5-alpine
    container_name: telemetra-redis
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      telemetra-network:
        aliases:
          - redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  questdb:
    image: questdb/questdb:9.1.1
    container_name: telemetra-questdb
    volumes:
      - questdb-data:/var/lib/questdb
    environment:
      - QDB_JAVA_OPTS=-Xms2G -Xmx8G -XX:+UseG1GC
      - QDB_HTTP_ENABLED=true
      - QDB_HTTP_BIND_TO=0.0.0.0:9000
      - QDB_HTTP_NET_CONNECTION_LIMIT=32
      - QDB_HTTP_SECURITY_READONLY=false
      - QDB_HTTP_MIN_ENABLED=false
      - QDB_HTTP_RECEIVE_BUFFER_SIZE=512K
      - QDB_PG_ENABLED=false
      - QDB_LINE_TCP_ENABLED=true
      - QDB_LINE_TCP_BIND_TO=0.0.0.0:9009
      - QDB_LINE_HTTP_ENABLED=true
      - QDB_SHARED_WORKER_COUNT=4
      - QDB_HTTP_WORKER_COUNT=4
      - QDB_CAIRO_PAGE_FRAME_COUNT=1024
      - QDB_CAIRO_PAGE_FRAME_SIZE=64k
      - QDB_CAIRO_O3_COLUMN_MEMORY_SIZE=2M
      - QDB_CAIRO_SQL_MAP_PAGE_SIZE=2M
      - QDB_CAIRO_WRITER_DATA_APPEND_PAGE_SIZE=1M
      - QDB_CAIRO_MAX_UNCOMMITTED_ROWS=250000
      - QDB_CAIRO_COMMIT_LAG=10000
      - QDB_CAIRO_SQL_QUERY_TIMEOUT=30000
      - QDB_LOG_W_LEVEL=CRITICAL
      - QDB_LOG_W_FILE_LOCATION=stdout
      - QDB_TELEMETRY_ENABLED=false
      - QDB_METRICS_ENABLED=false
    networks:
      telemetra-network:
        aliases:
          - questdb
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/9000 || exit 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: telemetra-server
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=3001
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - WEB_URL=${WEB_URL}
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/telemetra
      - REDIS_URL=redis://redis:6379
    expose:
      - "3001"
    depends_on:
      postgres:
        condition: service_healthy
      questdb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      telemetra-network:
        aliases:
          - server
    healthcheck:
      test: ["CMD", "/bin/busybox", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        - NODE_ENV=${NODE_ENV}
        - NEXT_TELEMETRY_DISABLED=1
    container_name: telemetra-web
    environment:
      - NODE_ENV=${NODE_ENV}
      - NEXT_TELEMETRY_DISABLED=1
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - WEB_URL=${WEB_URL}
    expose:
      - "3002"
    depends_on:
      server:
        condition: service_healthy
    networks:
      telemetra-network:
        aliases:
          - web
    healthcheck:
      test: ["CMD", "/bin/busybox", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

networks:
  telemetra-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  questdb-data:
    driver: local
  redis-data:
    driver: local

